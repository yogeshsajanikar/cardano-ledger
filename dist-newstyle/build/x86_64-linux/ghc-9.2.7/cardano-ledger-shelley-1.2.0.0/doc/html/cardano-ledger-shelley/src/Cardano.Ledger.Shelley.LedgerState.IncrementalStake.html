<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-comment">-- ===========================================================================</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- There are three parts to IncrementalStaking.</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- 1) The incremental part, where we keep track of each update to the UTxO</span><span>
</span><span id="line-11"></span><span class="hs-comment">--    adding Inputs and deleting consumed Outputs. Done in the Utxo rules.</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- 2) Finalizing and aggregating by stake credential to create a Snapshot.</span><span>
</span><span id="line-13"></span><span class="hs-comment">--    done in the Snap rules.</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- 3) Applying the RewardUpdate, to the Rewards component of the UMap.</span><span>
</span><span id="line-15"></span><span class="hs-comment">--    done in the NewEpoch rules.</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Ledger.Shelley.LedgerState.IncrementalStake</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-18"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#updateStakeDistribution"><span class="hs-identifier">updateStakeDistribution</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#incrementalStakeDistr"><span class="hs-identifier">incrementalStakeDistr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#applyRUpd"><span class="hs-identifier">applyRUpd</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#applyRUpdFiltered"><span class="hs-identifier">applyRUpdFiltered</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#smartUTxOState"><span class="hs-identifier">smartUTxOState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#filterAllRewards"><span class="hs-identifier">filterAllRewards</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#FilteredRewards"><span class="hs-identifier">FilteredRewards</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">where</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.Address</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Addr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.BaseTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">ProtVer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.CertState</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-31"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">CertState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">DState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">PState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">delegations</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">rewards</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.Coin</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Coin</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">addDeltaCoin</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.Compactible</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.Core</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.Credential</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-44"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Credential</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">StakeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">StakeRefBase</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">StakeRefPtr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.EpochBoundary</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">SnapShot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Stake</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.Keys</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">KeyRole</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Governance.html"><span class="hs-identifier">Cardano.Ledger.Shelley.Governance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.Governance.html#EraGovernance"><span class="hs-identifier">EraGovernance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.Governance.html#GovernanceState"><span class="hs-identifier">GovernanceState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.HardForks.html"><span class="hs-identifier">Cardano.Ledger.Shelley.HardForks</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HardForks</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html"><span class="hs-identifier">Cardano.Ledger.Shelley.LedgerState.Types</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html"><span class="hs-identifier">Cardano.Ledger.Shelley.RewardUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardUpdate"><span class="hs-identifier">RewardUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html"><span class="hs-identifier">Cardano.Ledger.Shelley.Rewards</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#aggregateCompactRewards"><span class="hs-identifier">aggregateCompactRewards</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#aggregateRewards"><span class="hs-identifier">aggregateRewards</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#filterRewards"><span class="hs-identifier">filterRewards</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.UMap</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-60"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Trip</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">UMap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">compactCoinOrError</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">member</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.UMap</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UM</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">Cardano.Ledger.UTxO</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier">UTxO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/deepseq-1.4.6.1/src"><span class="hs-identifier">Control.DeepSeq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/deepseq-1.4.6.1/src"><span class="hs-identifier">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/deepseq-1.4.6.1/src"><span class="hs-identifier">rnf</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/deepseq-1.4.6.1/src"><span class="hs-identifier">deepseq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">assert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">fold</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Group</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">invert</span></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Internal.Debug</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">valid</span></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Map</span></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Set</span></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/vector-map-1.0.1.0/doc/html/vector-map/src"><span class="hs-identifier">Data.VMap</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VMap</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Lens.Micro</span></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">-- =======================================================================</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- Part 1, Incrementally updating the IncrementalStake in Utxo rule</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- =======================================================================</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-comment">-- | Incrementally add the inserts 'utxoAdd' and the deletes 'utxoDel' to the IncrementalStake.</span><span>
</span><span id="line-85"></span><span id="local-6989586621679520616"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#updateStakeDistribution"><span class="hs-identifier hs-type">updateStakeDistribution</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraTxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520616"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520616"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520616"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520616"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520616"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520616"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-92"></span><span id="updateStakeDistribution"><span class="annot"><span class="annottext">updateStakeDistribution :: forall era.
EraTxOut era =&gt;
PParams era
-&gt; IncrementalStake (EraCrypto era)
-&gt; UTxO era
-&gt; UTxO era
-&gt; IncrementalStake (EraCrypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#updateStakeDistribution"><span class="hs-identifier hs-var hs-var">updateStakeDistribution</span></a></span></span><span> </span><span id="local-6989586621679520404"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520404"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span id="local-6989586621679520403"><span class="annot"><span class="annottext">IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520403"><span class="hs-identifier hs-var">incStake0</span></a></span></span><span> </span><span id="local-6989586621679520402"><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679520402"><span class="hs-identifier hs-var">utxoDel</span></a></span></span><span> </span><span id="local-6989586621679520401"><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679520401"><span class="hs-identifier hs-var">utxoAdd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520400"><span class="hs-identifier hs-var">incStake2</span></a></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-94"></span><span>    </span><span id="local-6989586621679520399"><span class="annot"><span class="annottext">incStake1 :: IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520399"><span class="hs-identifier hs-var hs-var">incStake1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era.
EraTxOut era =&gt;
PParams era
-&gt; (Coin -&gt; Coin)
-&gt; UTxO era
-&gt; IncrementalStake (EraCrypto era)
-&gt; IncrementalStake (EraCrypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#incrementalAggregateUtxoCoinByCredential"><span class="hs-identifier hs-var">incrementalAggregateUtxoCoinByCredential</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520404"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679520401"><span class="hs-identifier hs-var">utxoAdd</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520403"><span class="hs-identifier hs-var">incStake0</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span id="local-6989586621679520400"><span class="annot"><span class="annottext">incStake2 :: IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520400"><span class="hs-identifier hs-var hs-var">incStake2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era.
EraTxOut era =&gt;
PParams era
-&gt; (Coin -&gt; Coin)
-&gt; UTxO era
-&gt; IncrementalStake (EraCrypto era)
-&gt; IncrementalStake (EraCrypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#incrementalAggregateUtxoCoinByCredential"><span class="hs-identifier hs-var">incrementalAggregateUtxoCoinByCredential</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520404"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">forall m. Group m =&gt; m -&gt; m
</span><span class="hs-identifier hs-var">invert</span></span><span> </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679520402"><span class="hs-identifier hs-var">utxoDel</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520399"><span class="hs-identifier hs-var">incStake1</span></a></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">-- | Incrementally sum up all the Coin, for each staking Credential, in the outputs of the UTxO, and</span><span>
</span><span id="line-98"></span><span class="hs-comment">--   &quot;add&quot; them to the IncrementalStake. &quot;add&quot; has different meaning depending on if we are inserting</span><span>
</span><span id="line-99"></span><span class="hs-comment">--   or deleting the UtxO entries. For inserts (mode is the identity: id) and for deletes (mode is invert).</span><span>
</span><span id="line-100"></span><span class="hs-comment">--   Never store a (Coin 0) balance, since these do not occur in the non-incremental style that</span><span>
</span><span id="line-101"></span><span class="hs-comment">--   works directly from the whole UTxO.</span><span>
</span><span id="line-102"></span><span class="hs-comment">--   This function has a non-incremental analog 'aggregateUtxoCoinByCredential' . In this incremental</span><span>
</span><span id="line-103"></span><span class="hs-comment">--   version we expect the size of the UTxO to be fairly small. I.e the number of inputs and outputs</span><span>
</span><span id="line-104"></span><span class="hs-comment">--   in a transaction, which is aways &lt; 4096, not millions, and very often &lt; 10).</span><span>
</span><span id="line-105"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#incrementalAggregateUtxoCoinByCredential"><span class="hs-identifier hs-type">incrementalAggregateUtxoCoinByCredential</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679520607"><span class="annot"><a href="#local-6989586621679520607"><span class="hs-identifier hs-type">era</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraTxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520607"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520607"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-110"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520607"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520607"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-112"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520607"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span id="incrementalAggregateUtxoCoinByCredential"><span class="annot"><span class="annottext">incrementalAggregateUtxoCoinByCredential :: forall era.
EraTxOut era =&gt;
PParams era
-&gt; (Coin -&gt; Coin)
-&gt; UTxO era
-&gt; IncrementalStake (EraCrypto era)
-&gt; IncrementalStake (EraCrypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#incrementalAggregateUtxoCoinByCredential"><span class="hs-identifier hs-var hs-var">incrementalAggregateUtxoCoinByCredential</span></a></span></span><span> </span><span id="local-6989586621679520374"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520374"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span id="local-6989586621679520373"><span class="annot"><span class="annottext">Coin -&gt; Coin
</span><a href="#local-6989586621679520373"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span id="local-6989586621679520371"><span class="annot"><span class="annottext">Map (TxIn (EraCrypto era)) (TxOut era)
</span><a href="#local-6989586621679520371"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679520370"><span class="annot"><span class="annottext">IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520370"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><span class="annottext">forall a b k. (a -&gt; b -&gt; a) -&gt; a -&gt; Map k b -&gt; a
</span><span class="hs-identifier hs-var">Map.foldl'</span></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (EraCrypto era)
-&gt; TxOut era -&gt; IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520368"><span class="hs-identifier hs-var">accum</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520370"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">Map (TxIn (EraCrypto era)) (TxOut era)
</span><a href="#local-6989586621679520371"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-116"></span><span>    </span><span id="local-6989586621679520367"><span class="annot"><span class="annottext">keepOrDelete :: Coin -&gt; Maybe Coin -&gt; Maybe Coin
</span><a href="#local-6989586621679520367"><span class="hs-identifier hs-var hs-var">keepOrDelete</span></a></span></span><span> </span><span id="local-6989586621679520366"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520366"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Coin
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin
</span><a href="#local-6989586621679520373"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520366"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-118"></span><span>        </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-119"></span><span>        </span><span id="local-6989586621679520364"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520364"><span class="hs-identifier hs-var">final</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520364"><span class="hs-identifier hs-var">final</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span class="annot"><a href="#local-6989586621679520367"><span class="hs-identifier hs-var">keepOrDelete</span></a></span><span> </span><span id="local-6989586621679520363"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520363"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679520362"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520362"><span class="hs-identifier hs-var">old</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-121"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin
</span><a href="#local-6989586621679520373"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520363"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520362"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-122"></span><span>        </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-123"></span><span>        </span><span id="local-6989586621679520361"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520361"><span class="hs-identifier hs-var">final</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520361"><span class="hs-identifier hs-var">final</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span id="local-6989586621679520360"><span class="annot"><span class="annottext">ignorePtrs :: Bool
</span><a href="#local-6989586621679520360"><span class="hs-identifier hs-var hs-var">ignorePtrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtVer -&gt; Bool
</span><a href="Cardano.Ledger.Shelley.HardForks.html#forgoPointerAddressResolution"><span class="hs-identifier hs-var">HardForks.forgoPointerAddressResolution</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520374"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall era. EraPParams era =&gt; Lens' (PParams era) ProtVer
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">ppProtocolVersionL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>    </span><span id="local-6989586621679520368"><span class="annot"><span class="annottext">accum :: IncrementalStake (EraCrypto era)
-&gt; TxOut era -&gt; IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520368"><span class="hs-identifier hs-var hs-var">accum</span></a></span></span><span> </span><span id="local-6989586621679520356"><span class="annot"><span class="annottext">ans :: IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520356"><span class="hs-identifier hs-var">ans</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#IStake"><span class="hs-identifier hs-type">IStake</span></a></span><span> </span><span id="local-6989586621679520354"><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520354"><span class="hs-identifier hs-var">stake</span></a></span></span><span> </span><span id="local-6989586621679520353"><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679520353"><span class="hs-identifier hs-var">ptrs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679520352"><span class="annot"><span class="annottext">TxOut era
</span><a href="#local-6989586621679520352"><span class="hs-identifier hs-var">out</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-126"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679520351"><span class="annot"><span class="annottext">c :: Coin
</span><a href="#local-6989586621679520351"><span class="hs-identifier hs-var hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxOut era
</span><a href="#local-6989586621679520352"><span class="hs-identifier hs-var">out</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall era. EraTxOut era =&gt; Lens' (TxOut era) Coin
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">coinTxOutL</span></a></span><span>
</span><span id="line-127"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TxOut era
</span><a href="#local-6989586621679520352"><span class="hs-identifier hs-var">out</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall era.
EraTxOut era =&gt;
Lens' (TxOut era) (Addr (EraCrypto era))
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">addrTxOutL</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-128"></span><span>            </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Addr</span></a></span><span> </span><span class="annot"><span class="annottext">Network
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PaymentCredential (EraCrypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">StakeRefPtr</span></a></span><span> </span><span id="local-6989586621679520347"><span class="annot"><span class="annottext">Ptr
</span><a href="#local-6989586621679520347"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-129"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520360"><span class="hs-identifier hs-var">ignorePtrs</span></a></span><span>
</span><span id="line-130"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520356"><span class="hs-identifier hs-var">ans</span></a></span><span>
</span><span id="line-131"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall c.
Map (Credential 'Staking c) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake c
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#IStake"><span class="hs-identifier hs-var">IStake</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520354"><span class="hs-identifier hs-var">stake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k a.
Ord k =&gt;
(Maybe a -&gt; Maybe a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.alter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; Maybe Coin -&gt; Maybe Coin
</span><a href="#local-6989586621679520367"><span class="hs-identifier hs-var">keepOrDelete</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520351"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr
</span><a href="#local-6989586621679520347"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679520353"><span class="hs-identifier hs-var">ptrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>            </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Addr</span></a></span><span> </span><span class="annot"><span class="annottext">Network
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PaymentCredential (EraCrypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">StakeRefBase</span></a></span><span> </span><span id="local-6989586621679520345"><span class="annot"><span class="annottext">Credential 'Staking (EraCrypto era)
</span><a href="#local-6989586621679520345"><span class="hs-identifier hs-var">hk</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall c.
Map (Credential 'Staking c) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake c
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#IStake"><span class="hs-identifier hs-var">IStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k a.
Ord k =&gt;
(Maybe a -&gt; Maybe a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.alter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; Maybe Coin -&gt; Maybe Coin
</span><a href="#local-6989586621679520367"><span class="hs-identifier hs-var">keepOrDelete</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520351"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Credential 'Staking (EraCrypto era)
</span><a href="#local-6989586621679520345"><span class="hs-identifier hs-var">hk</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520354"><span class="hs-identifier hs-var">stake</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679520353"><span class="hs-identifier hs-var">ptrs</span></a></span><span>
</span><span id="line-133"></span><span>            </span><span id="local-6989586621679520344"><span class="annot"><span class="annottext">Addr (EraCrypto era)
</span><a href="#local-6989586621679520344"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IncrementalStake (EraCrypto era)
</span><a href="#local-6989586621679520356"><span class="hs-identifier hs-var">ans</span></a></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span class="hs-comment">-- ================================================</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-comment">-- | A valid (or self-consistent) UTxOState{utxosUtxo, utxosDeposited , utxosFees  , utxosPpups , utxosStakeDistr}</span><span>
</span><span id="line-138"></span><span class="hs-comment">--   maintains an invariant between the utxosUtxo and utxosStakeDistr fields. the utxosStakeDistr field is</span><span>
</span><span id="line-139"></span><span class="hs-comment">--   the aggregation of Coin over the StakeReferences in the UTxO. It can be computed by a pure</span><span>
</span><span id="line-140"></span><span class="hs-comment">--   function from the _utxo field. In some situations, mostly unit or example tests, or when</span><span>
</span><span id="line-141"></span><span class="hs-comment">--   initializing a small UTxO, we want to create a UTxOState that computes the utxosStakeDistr from</span><span>
</span><span id="line-142"></span><span class="hs-comment">--   the utxosUtxo. This is aways safe to do, but if the utxosUtxo field is big, this can be very expensive,</span><span>
</span><span id="line-143"></span><span class="hs-comment">--   which defeats the purpose of memoizing the utxosStakeDistr field. So use of this function should be</span><span>
</span><span id="line-144"></span><span class="hs-comment">--   restricted to tests and initializations, where the invariant should be maintained.</span><span>
</span><span id="line-145"></span><span class="hs-comment">--</span><span>
</span><span id="line-146"></span><span class="hs-comment">--   TO IncrementalStake</span><span>
</span><span id="line-147"></span><span id="local-6989586621679520571"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#smartUTxOState"><span class="hs-identifier hs-type">smartUTxOState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraTxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520571"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520571"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-150"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520571"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-151"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-152"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-153"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.Governance.html#GovernanceState"><span class="hs-identifier hs-type">GovernanceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520571"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520571"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-155"></span><span id="smartUTxOState"><span class="annot"><span class="annottext">smartUTxOState :: forall era.
EraTxOut era =&gt;
PParams era
-&gt; UTxO era -&gt; Coin -&gt; Coin -&gt; GovernanceState era -&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#smartUTxOState"><span class="hs-identifier hs-var hs-var">smartUTxOState</span></a></span></span><span> </span><span id="local-6989586621679520334"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520334"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span id="local-6989586621679520333"><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679520333"><span class="hs-identifier hs-var">utxo</span></a></span></span><span> </span><span id="local-6989586621679520332"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520332"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span id="local-6989586621679520331"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520331"><span class="hs-identifier hs-var">c2</span></a></span></span><span> </span><span id="local-6989586621679520330"><span class="annot"><span class="annottext">GovernanceState era
</span><a href="#local-6989586621679520330"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><span class="annottext">forall era.
UTxO era
-&gt; Coin
-&gt; Coin
-&gt; GovernanceState era
-&gt; IncrementalStake (EraCrypto era)
-&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#UTxOState"><span class="hs-identifier hs-var">UTxOState</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679520333"><span class="hs-identifier hs-var">utxo</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520332"><span class="hs-identifier hs-var">c1</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520331"><span class="hs-identifier hs-var">c2</span></a></span><span>
</span><span id="line-160"></span><span>    </span><span class="annot"><span class="annottext">GovernanceState era
</span><a href="#local-6989586621679520330"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall era.
EraTxOut era =&gt;
PParams era
-&gt; IncrementalStake (EraCrypto era)
-&gt; UTxO era
-&gt; UTxO era
-&gt; IncrementalStake (EraCrypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#updateStakeDistribution"><span class="hs-identifier hs-var">updateStakeDistribution</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520334"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679520333"><span class="hs-identifier hs-var">utxo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">-- =======================================================================</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- Part 2. Compute a Snapshot using the IncrementalStake in Snap rule</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- =======================================================================</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="hs-comment">-- | This computes a Snapshot using IncrementalStake (which is an</span><span>
</span><span id="line-168"></span><span class="hs-comment">--   aggregate of the current UTxO) and UMap (which tracks Coin,</span><span>
</span><span id="line-169"></span><span class="hs-comment">--   Delegations, and Ptrs simultaneously).  Note that logically:</span><span>
</span><span id="line-170"></span><span class="hs-comment">--   1) IncrementalStake = (credStake, ptrStake)</span><span>
</span><span id="line-171"></span><span class="hs-comment">--   2) UMap = (rewards, activeDelegs, ptrmap :: Map ptr cred)</span><span>
</span><span id="line-172"></span><span class="hs-comment">--</span><span>
</span><span id="line-173"></span><span class="hs-comment">--   Using this scheme the logic can do 3 things in one go, without touching the UTxO.</span><span>
</span><span id="line-174"></span><span class="hs-comment">--   1) Resolve Pointers</span><span>
</span><span id="line-175"></span><span class="hs-comment">--   2) Throw away things not actively delegated</span><span>
</span><span id="line-176"></span><span class="hs-comment">--   3) Add up the coin</span><span>
</span><span id="line-177"></span><span class="hs-comment">--</span><span>
</span><span id="line-178"></span><span class="hs-comment">--   The Stake distribution function (Map cred coin) (the first component of a SnapShot)</span><span>
</span><span id="line-179"></span><span class="hs-comment">--   is defined by this SetAlgebra expression:</span><span>
</span><span id="line-180"></span><span class="hs-comment">--   (dom activeDelegs) &#9665; (aggregate+ (credStake &#8746; ptrStake &#8746; rewards))</span><span>
</span><span id="line-181"></span><span class="hs-comment">--</span><span>
</span><span id="line-182"></span><span class="hs-comment">--   We can apply meaning preserving operations to get equivalent expressions</span><span>
</span><span id="line-183"></span><span class="hs-comment">--</span><span>
</span><span id="line-184"></span><span class="hs-comment">--   (dom activeDelegs) &#9665; (aggregate+ (credStake &#8746; ptrStake &#8746; rewards))</span><span>
</span><span id="line-185"></span><span class="hs-comment">--   aggregate+ (dom activeDelegs &#9665; (credStake &#8746; ptrStake &#8746; rewards))</span><span>
</span><span id="line-186"></span><span class="hs-comment">--   aggregate+ ((dom activeDelegs &#9665; credStake) &#8746; (dom activeDelegs &#9665; ptrStake) &#8746; (dom activeDelegs &#9665; rewards))</span><span>
</span><span id="line-187"></span><span class="hs-comment">--</span><span>
</span><span id="line-188"></span><span class="hs-comment">--   We will compute this in several steps</span><span>
</span><span id="line-189"></span><span class="hs-comment">--   step1 = (dom activeDelegs &#9665; credStake) &#8746; (dom activeDelegs &#9665; ptrStake)</span><span>
</span><span id="line-190"></span><span class="hs-comment">--   step2 =  aggregate (dom activeDelegs &#9665; rewards) step1</span><span>
</span><span id="line-191"></span><span class="hs-comment">--   This function has a non-incremental analog, 'stakeDistr', mosty used in tests, which does use the UTxO.</span><span>
</span><span id="line-192"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#incrementalStakeDistr"><span class="hs-identifier hs-type">incrementalStakeDistr</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679520561"><span class="annot"><a href="#local-6989586621679520561"><span class="hs-identifier hs-type">era</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-194"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraPParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520561"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-195"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520561"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520561"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520561"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520561"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">SnapShot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520561"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span id="incrementalStakeDistr"><span class="annot"><span class="annottext">incrementalStakeDistr :: forall era.
EraPParams era =&gt;
PParams era
-&gt; IncrementalStake (EraCrypto era)
-&gt; DState era
-&gt; PState era
-&gt; SnapShot (EraCrypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#incrementalStakeDistr"><span class="hs-identifier hs-var hs-var">incrementalStakeDistr</span></a></span></span><span> </span><span id="local-6989586621679520305"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520305"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#IStake"><span class="hs-identifier hs-type">IStake</span></a></span><span> </span><span id="local-6989586621679520304"><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520304"><span class="hs-identifier hs-var">credStake</span></a></span></span><span> </span><span id="local-6989586621679520303"><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679520303"><span class="hs-identifier hs-var">ptrStake</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679520302"><span class="annot"><span class="annottext">DState era
</span><a href="#local-6989586621679520302"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span id="local-6989586621679520301"><span class="annot"><span class="annottext">PState era
</span><a href="#local-6989586621679520301"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><span class="annottext">forall c.
Stake c
-&gt; VMap VB VB (Credential 'Staking c) (KeyHash 'StakePool c)
-&gt; VMap VB VB (KeyHash 'StakePool c) (PoolParams c)
-&gt; SnapShot c
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">SnapShot</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall c.
VMap VB VP (Credential 'Staking c) (CompactForm Coin) -&gt; Stake c
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">Stake</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (kv :: * -&gt; *) k (vv :: * -&gt; *) v.
(Vector kv k, Vector vv v) =&gt;
Map k v -&gt; VMap kv vv k v
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/vector-map-1.0.1.0/doc/html/vector-map/src"><span class="hs-identifier hs-var">VMap.fromMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; Coin -&gt; CompactForm Coin
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">compactCoinOrError</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520296"><span class="hs-identifier hs-var">step2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><span class="annottext">VMap
  VB
  VB
  (Credential 'Staking (EraCrypto era))
  (KeyHash 'StakePool (EraCrypto era))
</span><a href="#local-6989586621679520295"><span class="hs-identifier hs-var">delegs_</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (kv :: * -&gt; *) k (vv :: * -&gt; *) v.
(Vector kv k, Vector vv v) =&gt;
Map k v -&gt; VMap kv vv k v
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/vector-map-1.0.1.0/doc/html/vector-map/src"><span class="hs-identifier hs-var">VMap.fromMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyHash 'StakePool (EraCrypto era)) (PoolParams (EraCrypto era))
</span><a href="#local-6989586621679520294"><span class="hs-identifier hs-var">poolParams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">UMap</span></a></span><span> </span><span id="local-6989586621679520292"><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) (Trip (EraCrypto era))
</span><a href="#local-6989586621679520292"><span class="hs-identifier hs-var">triplesMap</span></a></span></span><span> </span><span id="local-6989586621679520291"><span class="annot"><span class="annottext">Map Ptr (Credential 'Staking (EraCrypto era))
</span><a href="#local-6989586621679520291"><span class="hs-identifier hs-var">ptrsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era. DState era -&gt; UMap (EraCrypto era)
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">dsUnified</span></a></span><span> </span><span class="annot"><span class="annottext">DState era
</span><a href="#local-6989586621679520302"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">psStakePoolParams :: forall era.
PState era
-&gt; Map
     (KeyHash 'StakePool (EraCrypto era)) (PoolParams (EraCrypto era))
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">psStakePoolParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679520294"><span class="annot"><span class="annottext">Map
  (KeyHash 'StakePool (EraCrypto era)) (PoolParams (EraCrypto era))
</span><a href="#local-6989586621679520294"><span class="hs-identifier hs-var">poolParams</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PState era
</span><a href="#local-6989586621679520301"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-208"></span><span>    </span><span id="local-6989586621679520295"><span class="annot"><span class="annottext">delegs_ :: VMap
  VB
  VB
  (Credential 'Staking (EraCrypto era))
  (KeyHash 'StakePool (EraCrypto era))
</span><a href="#local-6989586621679520295"><span class="hs-identifier hs-var hs-var">delegs_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall c k v. View c k v -&gt; VMap VB VB k v
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">UM.viewToVMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall era.
DState era
-&gt; View
     (EraCrypto era)
     (Credential 'Staking (EraCrypto era))
     (KeyHash 'StakePool (EraCrypto era))
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">delegations</span></a></span><span> </span><span class="annot"><span class="annottext">DState era
</span><a href="#local-6989586621679520302"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-comment">-- A credential is active, only if it is being delegated</span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621679520286"><span class="annot"><span class="annottext">activeCreds :: Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520286"><span class="hs-identifier hs-var hs-var">activeCreds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.filterWithKey</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679520284"><span class="annot"><span class="annottext">Credential 'Staking (EraCrypto era)
</span><a href="#local-6989586621679520284"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coin
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall k (kv :: * -&gt; *) (vv :: * -&gt; *) v.
(Ord k, Vector kv k) =&gt;
k -&gt; VMap kv vv k v -&gt; Bool
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/vector-map-1.0.1.0/doc/html/vector-map/src"><span class="hs-identifier hs-var">VMap.member</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking (EraCrypto era)
</span><a href="#local-6989586621679520284"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">VMap
  VB
  VB
  (Credential 'Staking (EraCrypto era))
  (KeyHash 'StakePool (EraCrypto era))
</span><a href="#local-6989586621679520295"><span class="hs-identifier hs-var">delegs_</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520304"><span class="hs-identifier hs-var">credStake</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621679520282"><span class="annot"><span class="annottext">ignorePtrs :: Bool
</span><a href="#local-6989586621679520282"><span class="hs-identifier hs-var hs-var">ignorePtrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtVer -&gt; Bool
</span><a href="Cardano.Ledger.Shelley.HardForks.html#forgoPointerAddressResolution"><span class="hs-identifier hs-var">HardForks.forgoPointerAddressResolution</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520305"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall era. EraPParams era =&gt; Lens' (PParams era) ProtVer
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">ppProtocolVersionL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-comment">-- pre Conway: (dom activeDelegs &#9665; credStake) &#8746; (dom activeDelegs &#9665; ptrStake)</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-comment">-- afterwards we forgo ptr resolution: (dom activeDelegs &#9665; credStake)</span><span>
</span><span id="line-214"></span><span>    </span><span id="local-6989586621679520281"><span class="annot"><span class="annottext">step1 :: Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520281"><span class="hs-identifier hs-var hs-var">step1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-215"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520282"><span class="hs-identifier hs-var">ignorePtrs</span></a></span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520286"><span class="hs-identifier hs-var">activeCreds</span></a></span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- Resolve inserts and delets which were indexed by ptrs, by looking them up in the ptrsMap</span><span>
</span><span id="line-218"></span><span>        </span><span class="hs-comment">-- and combining the result of the lookup with teh ordinary stake, keeping only the active credentials</span><span>
</span><span id="line-219"></span><span>          </span><span class="annot"><span class="annottext">forall a k b. (a -&gt; k -&gt; b -&gt; a) -&gt; a -&gt; Map k b -&gt; a
</span><span class="hs-identifier hs-var">Map.foldlWithKey'</span></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
-&gt; Ptr -&gt; Coin -&gt; Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520279"><span class="hs-identifier hs-var">addResolvedPointer</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520286"><span class="hs-identifier hs-var">activeCreds</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679520303"><span class="hs-identifier hs-var">ptrStake</span></a></span><span>
</span><span id="line-220"></span><span>    </span><span id="local-6989586621679520296"><span class="annot"><span class="annottext">step2 :: Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520296"><span class="hs-identifier hs-var hs-var">step2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k c. Ord k =&gt; Map k (Trip c) -&gt; Map k Coin -&gt; Map k Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#aggregateActiveStake"><span class="hs-identifier hs-var">aggregateActiveStake</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) (Trip (EraCrypto era))
</span><a href="#local-6989586621679520292"><span class="hs-identifier hs-var">triplesMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520281"><span class="hs-identifier hs-var">step1</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span id="local-6989586621679520279"><span class="annot"><span class="annottext">addResolvedPointer :: Map (Credential 'Staking (EraCrypto era)) Coin
-&gt; Ptr -&gt; Coin -&gt; Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520279"><span class="hs-identifier hs-var hs-var">addResolvedPointer</span></a></span></span><span> </span><span id="local-6989586621679520277"><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520277"><span class="hs-identifier hs-var">ans</span></a></span></span><span> </span><span id="local-6989586621679520276"><span class="annot"><span class="annottext">Ptr
</span><a href="#local-6989586621679520276"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679520275"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520275"><span class="hs-identifier hs-var">coin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-222"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Ptr
</span><a href="#local-6989586621679520276"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr (Credential 'Staking (EraCrypto era))
</span><a href="#local-6989586621679520291"><span class="hs-identifier hs-var">ptrsMap</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-comment">-- map of ptrs to credentials</span><span>
</span><span id="line-223"></span><span>        </span><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679520273"><span class="annot"><span class="annottext">Credential 'Staking (EraCrypto era)
</span><a href="#local-6989586621679520273"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall k (kv :: * -&gt; *) (vv :: * -&gt; *) v.
(Ord k, Vector kv k) =&gt;
k -&gt; VMap kv vv k v -&gt; Bool
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/vector-map-1.0.1.0/doc/html/vector-map/src"><span class="hs-identifier hs-var">VMap.member</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking (EraCrypto era)
</span><a href="#local-6989586621679520273"><span class="hs-identifier hs-var">cred</span></a></span><span> </span><span class="annot"><span class="annottext">VMap
  VB
  VB
  (Credential 'Staking (EraCrypto era))
  (KeyHash 'StakePool (EraCrypto era))
</span><a href="#local-6989586621679520295"><span class="hs-identifier hs-var">delegs_</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insertWith</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">(&lt;&gt;)</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking (EraCrypto era)
</span><a href="#local-6989586621679520273"><span class="hs-identifier hs-var">cred</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520275"><span class="hs-identifier hs-var">coin</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520277"><span class="hs-identifier hs-var">ans</span></a></span><span>
</span><span id="line-224"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Credential 'Staking (EraCrypto era))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) Coin
</span><a href="#local-6989586621679520277"><span class="hs-identifier hs-var">ans</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">-- | Aggregate active stake by merging two maps. The triple map from the</span><span>
</span><span id="line-227"></span><span class="hs-comment">--   UMap, and the IncrementalStake. Only keep the active stake. Active can</span><span>
</span><span id="line-228"></span><span class="hs-comment">--   be determined if there is a (SJust deleg) in the Triple.  This is step2 =</span><span>
</span><span id="line-229"></span><span class="hs-comment">--   aggregate (dom activeDelegs &#9665; rewards) step1</span><span>
</span><span id="line-230"></span><span id="local-6989586621679520511"><span id="local-6989586621679520512"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#aggregateActiveStake"><span class="hs-identifier hs-type">aggregateActiveStake</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520512"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679520512"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Trip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520511"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679520512"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679520512"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Coin</span></a></span></span></span><span>
</span><span id="line-231"></span><span id="aggregateActiveStake"><span class="annot"><span class="annottext">aggregateActiveStake :: forall k c. Ord k =&gt; Map k (Trip c) -&gt; Map k Coin -&gt; Map k Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#aggregateActiveStake"><span class="hs-identifier hs-var hs-var">aggregateActiveStake</span></a></span></span><span> </span><span id="local-6989586621679520259"><span class="annot"><span class="annottext">Map k (Trip c)
</span><a href="#local-6989586621679520259"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span id="local-6989586621679520258"><span class="annot"><span class="annottext">Map k Coin
</span><a href="#local-6989586621679520258"><span class="hs-identifier hs-var">m2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">Map.valid</span></span><span> </span><span class="annot"><span class="annottext">Map k Coin
</span><a href="#local-6989586621679520257"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map k Coin
</span><a href="#local-6989586621679520257"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621679520257"><span class="annot"><span class="annottext">m :: Map k Coin
</span><a href="#local-6989586621679520257"><span class="hs-identifier hs-var hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-234"></span><span>      </span><span class="annot"><span class="annottext">forall k a b c.
Ord k =&gt;
(k -&gt; a -&gt; b -&gt; Maybe c)
-&gt; (Map k a -&gt; Map k c)
-&gt; (Map k b -&gt; Map k c)
-&gt; Map k a
-&gt; Map k b
-&gt; Map k c
</span><span class="hs-identifier hs-var">Map.mergeWithKey</span></span><span>
</span><span id="line-235"></span><span>        </span><span class="hs-comment">-- How to merge the ranges of the two maps where they have a common key. Below</span><span>
</span><span id="line-236"></span><span>        </span><span class="hs-comment">-- 'coin1' and 'coin2' have the same key, '_k', and the stake is active if the delegation is SJust</span><span>
</span><span id="line-237"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679520255"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679520255"><span class="hs-identifier hs-var">_k</span></a></span></span><span> </span><span id="local-6989586621679520254"><span class="annot"><span class="annottext">Trip c
</span><a href="#local-6989586621679520254"><span class="hs-identifier hs-var">trip</span></a></span></span><span> </span><span id="local-6989586621679520253"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520253"><span class="hs-identifier hs-var">coin2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; RDPair -&gt; Coin
</span><a href="#local-6989586621679520252"><span class="hs-identifier hs-var">extractAndAdd</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520253"><span class="hs-identifier hs-var">coin2</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall c. Trip c -&gt; Maybe RDPair
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">UM.tripRewardActiveDelegation</span></a></span><span> </span><span class="annot"><span class="annottext">Trip c
</span><a href="#local-6989586621679520254"><span class="hs-identifier hs-var">trip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>        </span><span class="hs-comment">-- what to do when a key appears just in 'tripmap', we only add the coin if the key is active</span><span>
</span><span id="line-239"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b k. (a -&gt; Maybe b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">Map.mapMaybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679520249"><span class="annot"><span class="annottext">Trip c
</span><a href="#local-6989586621679520249"><span class="hs-identifier hs-var">trip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Compactible a =&gt; CompactForm a -&gt; a
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">fromCompact</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">RDPair -&gt; CompactForm Coin
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">UM.rdReward</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall c. Trip c -&gt; Maybe RDPair
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">UM.tripRewardActiveDelegation</span></a></span><span> </span><span class="annot"><span class="annottext">Trip c
</span><a href="#local-6989586621679520249"><span class="hs-identifier hs-var">trip</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>        </span><span class="hs-comment">-- what to do when a key is only in 'incremental', keep everything, because at</span><span>
</span><span id="line-241"></span><span>        </span><span class="hs-comment">-- the call site of aggregateActiveStake, the arg 'incremental' is filtered by</span><span>
</span><span id="line-242"></span><span>        </span><span class="hs-comment">-- 'resolveActiveIncrementalPtrs' which guarantees that only active stake is included.</span><span>
</span><span id="line-243"></span><span>        </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-244"></span><span>        </span><span class="annot"><span class="annottext">Map k (Trip c)
</span><a href="#local-6989586621679520259"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-245"></span><span>        </span><span class="annot"><span class="annottext">Map k Coin
</span><a href="#local-6989586621679520258"><span class="hs-identifier hs-var">m2</span></a></span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><a href="#local-6989586621679520252"><span class="hs-identifier hs-type">extractAndAdd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">UM.RDPair</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Coin</span></a></span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621679520252"><span class="annot"><span class="annottext">extractAndAdd :: Coin -&gt; RDPair -&gt; Coin
</span><a href="#local-6989586621679520252"><span class="hs-identifier hs-var hs-var">extractAndAdd</span></a></span></span><span> </span><span id="local-6989586621679520245"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520245"><span class="hs-identifier hs-var">coin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">UM.RDPair</span></a></span><span> </span><span id="local-6989586621679520243"><span class="annot"><span class="annottext">CompactForm Coin
</span><a href="#local-6989586621679520243"><span class="hs-identifier hs-var">rew</span></a></span></span><span> </span><span id="local-6989586621679520242"><span class="annot"><span class="annottext">CompactForm Coin
</span><a href="#local-6989586621679520242"><span class="hs-identifier hs-var">_dep</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520245"><span class="hs-identifier hs-var">coin</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Compactible a =&gt; CompactForm a -&gt; a
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">fromCompact</span></a></span><span> </span><span class="annot"><span class="annottext">CompactForm Coin
</span><a href="#local-6989586621679520243"><span class="hs-identifier hs-var">rew</span></a></span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span class="hs-comment">-- =====================================================</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- Part 3 Apply a reward update, in NewEpoch rule</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- =====================================================</span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="hs-comment">-- | Apply a RewardUpdate to the EpochState. Does several things</span><span>
</span><span id="line-254"></span><span class="hs-comment">--   1) Adds reward coins to Rewards component of the UMap field of the DState,</span><span>
</span><span id="line-255"></span><span class="hs-comment">--      for actively delegated Stake</span><span>
</span><span id="line-256"></span><span class="hs-comment">--   2) Adds to the Treasury of the AccountState for non-actively delegated stake</span><span>
</span><span id="line-257"></span><span class="hs-comment">--   3) Adds fees to the UTxOState</span><span>
</span><span id="line-258"></span><span id="local-6989586621679520487"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#applyRUpd"><span class="hs-identifier hs-type">applyRUpd</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraPParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520487"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardUpdate"><span class="hs-identifier hs-type">RewardUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520487"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520487"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-262"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520487"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-263"></span><span id="applyRUpd"><span class="annot"><span class="annottext">applyRUpd :: forall era.
EraPParams era =&gt;
RewardUpdate (EraCrypto era) -&gt; EpochState era -&gt; EpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#applyRUpd"><span class="hs-identifier hs-var hs-var">applyRUpd</span></a></span></span><span> </span><span id="local-6989586621679520239"><span class="annot"><span class="annottext">RewardUpdate (EraCrypto era)
</span><a href="#local-6989586621679520239"><span class="hs-identifier hs-var">ru</span></a></span></span><span> </span><span id="local-6989586621679520238"><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679520238"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679520237"><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679520237"><span class="hs-identifier hs-var">es'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilteredRewards era
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era.
EraPParams era =&gt;
RewardUpdate (EraCrypto era)
-&gt; EpochState era -&gt; (EpochState era, FilteredRewards era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#applyRUpdFiltered"><span class="hs-identifier hs-var">applyRUpdFiltered</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (EraCrypto era)
</span><a href="#local-6989586621679520239"><span class="hs-identifier hs-var">ru</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679520238"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-265"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679520237"><span class="hs-identifier hs-var">es'</span></a></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="hs-comment">-- TO IncrementalStake</span><span>
</span><span id="line-268"></span><span id="local-6989586621679520482"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#applyRUpdFiltered"><span class="hs-identifier hs-type">applyRUpdFiltered</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraPParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520482"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardUpdate"><span class="hs-identifier hs-type">RewardUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520482"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-271"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520482"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520482"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#FilteredRewards"><span class="hs-identifier hs-type">FilteredRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520482"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-273"></span><span id="applyRUpdFiltered"><span class="annot"><span class="annottext">applyRUpdFiltered :: forall era.
EraPParams era =&gt;
RewardUpdate (EraCrypto era)
-&gt; EpochState era -&gt; (EpochState era, FilteredRewards era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#applyRUpdFiltered"><span class="hs-identifier hs-var hs-var">applyRUpdFiltered</span></a></span></span><span>
</span><span id="line-274"></span><span>  </span><span id="local-6989586621679520232"><span class="annot"><span class="annottext">RewardUpdate (EraCrypto era)
</span><a href="#local-6989586621679520232"><span class="hs-identifier hs-var">ru</span></a></span></span><span>
</span><span id="line-275"></span><span>  </span><span id="local-6989586621679520231"><span class="annot"><span class="annottext">es :: EpochState era
</span><a href="#local-6989586621679520231"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span id="local-6989586621679520229"><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679520229"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621679520228"><span class="annot"><span class="annottext">SnapShots (EraCrypto era)
</span><a href="#local-6989586621679520228"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621679520227"><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679520227"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621679520226"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520226"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679520225"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520225"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span id="local-6989586621679520224"><span class="annot"><span class="annottext">NonMyopic (EraCrypto era)
</span><a href="#local-6989586621679520224"><span class="hs-identifier hs-var">_nm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679520223"><span class="hs-identifier hs-var">epochStateAns</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilteredRewards era
</span><a href="#local-6989586621679520222"><span class="hs-identifier hs-var">filteredRewards</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-277"></span><span>      </span><span class="hs-glyph">!</span><span id="local-6989586621679520223"><span class="annot"><span class="annottext">epochStateAns :: EpochState era
</span><a href="#local-6989586621679520223"><span class="hs-identifier hs-var hs-var">epochStateAns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era.
AccountState
-&gt; SnapShots (EraCrypto era)
-&gt; LedgerState era
-&gt; PParams era
-&gt; PParams era
-&gt; NonMyopic (EraCrypto era)
-&gt; EpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#EpochState"><span class="hs-identifier hs-var">EpochState</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679520221"><span class="hs-identifier hs-var">as'</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShots (EraCrypto era)
</span><a href="#local-6989586621679520228"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679520220"><span class="hs-identifier hs-var">ls'</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520226"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520225"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">NonMyopic (EraCrypto era)
</span><a href="#local-6989586621679520219"><span class="hs-identifier hs-var">nm'</span></a></span><span>
</span><span id="line-278"></span><span>      </span><span id="local-6989586621679520218"><span class="annot"><span class="annottext">utxoState_ :: UTxOState era
</span><a href="#local-6989586621679520218"><span class="hs-identifier hs-var hs-var">utxoState_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era. LedgerState era -&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#lsUTxOState"><span class="hs-identifier hs-var">lsUTxOState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679520227"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-279"></span><span>      </span><span id="local-6989586621679520216"><span class="annot"><span class="annottext">dpState :: CertState era
</span><a href="#local-6989586621679520216"><span class="hs-identifier hs-var hs-var">dpState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era. LedgerState era -&gt; CertState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#lsCertState"><span class="hs-identifier hs-var">lsCertState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679520227"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-280"></span><span>      </span><span id="local-6989586621679520214"><span class="annot"><span class="annottext">dState :: DState era
</span><a href="#local-6989586621679520214"><span class="hs-identifier hs-var hs-var">dState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era. CertState era -&gt; DState era
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">certDState</span></a></span><span> </span><span class="annot"><span class="annottext">CertState era
</span><a href="#local-6989586621679520216"><span class="hs-identifier hs-var">dpState</span></a></span><span>
</span><span id="line-281"></span><span>      </span><span id="local-6989586621679520212"><span class="annot"><span class="annottext">prevPParams :: PParams era
</span><a href="#local-6989586621679520212"><span class="hs-identifier hs-var hs-var">prevPParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era. EpochState era -&gt; PParams era
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#esPrevPp"><span class="hs-identifier hs-var">esPrevPp</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679520231"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-282"></span><span>      </span><span id="local-6989586621679520210"><span class="annot"><span class="annottext">prevProVer :: ProtVer
</span><a href="#local-6989586621679520210"><span class="hs-identifier hs-var hs-var">prevProVer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679520212"><span class="hs-identifier hs-var">prevPParams</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall era. EraPParams era =&gt; Lens' (PParams era) ProtVer
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">ppProtocolVersionL</span></a></span><span>
</span><span id="line-283"></span><span>      </span><span id="local-6989586621679520222"><span class="annot"><span class="annottext">filteredRewards :: FilteredRewards era
</span><a href="#local-6989586621679520222"><span class="hs-identifier hs-var">filteredRewards</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#FilteredRewards"><span class="hs-identifier hs-type">FilteredRewards</span></a></span><span>
</span><span id="line-284"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679520208"><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
frRegistered :: forall era.
FilteredRewards era
-&gt; Map
     (Credential 'Staking (EraCrypto era))
     (Set (Reward (EraCrypto era)))
frRegistered :: Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#frRegistered"><span class="hs-identifier hs-var hs-var">frRegistered</span></a></span></span><span>
</span><span id="line-285"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679520206"><span class="annot"><span class="annottext">Coin
frTotalUnregistered :: forall era. FilteredRewards era -&gt; Coin
frTotalUnregistered :: Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#frTotalUnregistered"><span class="hs-identifier hs-var hs-var">frTotalUnregistered</span></a></span></span><span>
</span><span id="line-286"></span><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era.
Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
-&gt; ProtVer -&gt; DState era -&gt; FilteredRewards era
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#filterAllRewards%27"><span class="hs-identifier hs-var">filterAllRewards'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall c.
RewardUpdate c -&gt; Map (Credential 'Staking c) (Set (Reward c))
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rs"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (EraCrypto era)
</span><a href="#local-6989586621679520232"><span class="hs-identifier hs-var">ru</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ProtVer
</span><a href="#local-6989586621679520210"><span class="hs-identifier hs-var">prevProVer</span></a></span><span> </span><span class="annot"><span class="annottext">DState era
</span><a href="#local-6989586621679520214"><span class="hs-identifier hs-var">dState</span></a></span><span>
</span><span id="line-287"></span><span>      </span><span class="hs-comment">-- Note: domain filteredRewards is a subset of domain (rewards dstate)</span><span>
</span><span id="line-288"></span><span>      </span><span id="local-6989586621679520202"><span class="annot"><span class="annottext">registeredAggregated :: Map (Credential 'Staking (EraCrypto era)) (CompactForm Coin)
</span><a href="#local-6989586621679520202"><span class="hs-identifier hs-var hs-var">registeredAggregated</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall c.
ProtVer
-&gt; Map (Credential 'Staking c) (Set (Reward c))
-&gt; Map (Credential 'Staking c) (CompactForm Coin)
</span><a href="Cardano.Ledger.Shelley.Rewards.html#aggregateCompactRewards"><span class="hs-identifier hs-var">aggregateCompactRewards</span></a></span><span> </span><span class="annot"><span class="annottext">ProtVer
</span><a href="#local-6989586621679520210"><span class="hs-identifier hs-var">prevProVer</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520208"><span class="hs-identifier hs-var">frRegistered</span></a></span><span>
</span><span id="line-289"></span><span>      </span><span class="hs-comment">-- Note: domain registeredAggregated is a subset of domain (rewards dstate)</span><span>
</span><span id="line-290"></span><span>      </span><span id="local-6989586621679520221"><span class="annot"><span class="annottext">as' :: AccountState
</span><a href="#local-6989586621679520221"><span class="hs-identifier hs-var hs-var">as'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-291"></span><span>        </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679520229"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-292"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">asTreasury :: Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#asTreasury"><span class="hs-identifier hs-var">asTreasury</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; DeltaCoin -&gt; Coin
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">addDeltaCoin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AccountState -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#asTreasury"><span class="hs-identifier hs-var">asTreasury</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679520229"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall c. RewardUpdate c -&gt; DeltaCoin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#deltaT"><span class="hs-identifier hs-var">deltaT</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (EraCrypto era)
</span><a href="#local-6989586621679520232"><span class="hs-identifier hs-var">ru</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520206"><span class="hs-identifier hs-var">frTotalUnregistered</span></a></span><span>
</span><span id="line-293"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">asReserves :: Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#asReserves"><span class="hs-identifier hs-var">asReserves</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; DeltaCoin -&gt; Coin
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">addDeltaCoin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AccountState -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#asReserves"><span class="hs-identifier hs-var">asReserves</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679520229"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall c. RewardUpdate c -&gt; DeltaCoin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#deltaR"><span class="hs-identifier hs-var">deltaR</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (EraCrypto era)
</span><a href="#local-6989586621679520232"><span class="hs-identifier hs-var">ru</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-295"></span><span>      </span><span id="local-6989586621679520220"><span class="annot"><span class="annottext">ls' :: LedgerState era
</span><a href="#local-6989586621679520220"><span class="hs-identifier hs-var hs-var">ls'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-296"></span><span>        </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679520227"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-297"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lsUTxOState :: UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#lsUTxOState"><span class="hs-identifier hs-var">lsUTxOState</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-298"></span><span>              </span><span class="annot"><span class="annottext">UTxOState era
</span><a href="#local-6989586621679520218"><span class="hs-identifier hs-var">utxoState_</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">utxosFees :: Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#utxosFees"><span class="hs-identifier hs-var">utxosFees</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era. UTxOState era -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#utxosFees"><span class="hs-identifier hs-var">utxosFees</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOState era
</span><a href="#local-6989586621679520218"><span class="hs-identifier hs-var">utxoState_</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; DeltaCoin -&gt; Coin
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-operator hs-var">`addDeltaCoin`</span></a></span><span> </span><span class="annot"><span class="annottext">forall c. RewardUpdate c -&gt; DeltaCoin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#deltaF"><span class="hs-identifier hs-var">deltaF</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (EraCrypto era)
</span><a href="#local-6989586621679520232"><span class="hs-identifier hs-var">ru</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-299"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lsCertState :: CertState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#lsCertState"><span class="hs-identifier hs-var">lsCertState</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>              </span><span class="annot"><span class="annottext">CertState era
</span><a href="#local-6989586621679520216"><span class="hs-identifier hs-var">dpState</span></a></span><span>
</span><span id="line-301"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">certDState :: DState era
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">certDState</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-302"></span><span>                    </span><span class="annot"><span class="annottext">DState era
</span><a href="#local-6989586621679520214"><span class="hs-identifier hs-var">dState</span></a></span><span>
</span><span id="line-303"></span><span>                      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">dsUnified :: UMap (EraCrypto era)
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">dsUnified</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era.
DState era
-&gt; View
     (EraCrypto era) (Credential 'Staking (EraCrypto era)) RDPair
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">rewards</span></a></span><span> </span><span class="annot"><span class="annottext">DState era
</span><a href="#local-6989586621679520214"><span class="hs-identifier hs-var">dState</span></a></span><span> </span><span class="annot"><span class="annottext">forall c k. View c k RDPair -&gt; Map k (CompactForm Coin) -&gt; UMap c
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-operator hs-var">UM.&#8746;+</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (EraCrypto era)) (CompactForm Coin)
</span><a href="#local-6989586621679520202"><span class="hs-identifier hs-var">registeredAggregated</span></a></span><span>
</span><span id="line-304"></span><span>                      </span><span class="hs-special">}</span><span>
</span><span id="line-305"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-306"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-307"></span><span>      </span><span id="local-6989586621679520219"><span class="annot"><span class="annottext">nm' :: NonMyopic (EraCrypto era)
</span><a href="#local-6989586621679520219"><span class="hs-identifier hs-var hs-var">nm'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall c. RewardUpdate c -&gt; NonMyopic c
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#nonMyopic"><span class="hs-identifier hs-var">nonMyopic</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (EraCrypto era)
</span><a href="#local-6989586621679520232"><span class="hs-identifier hs-var">ru</span></a></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="hs-keyword">data</span><span> </span><span id="FilteredRewards"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#FilteredRewards"><span class="hs-identifier hs-var">FilteredRewards</span></a></span></span><span> </span><span id="local-6989586621679520470"><span class="annot"><a href="#local-6989586621679520470"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FilteredRewards"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#FilteredRewards"><span class="hs-identifier hs-var">FilteredRewards</span></a></span></span><span>
</span><span id="line-310"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Only the first component is strict on purpose. The others are lazy because in most instances</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-comment">-- they are never used, so this keeps them from being evaluated.</span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span>    </span><span id="frRegistered"><span class="annot"><span class="annottext">forall era.
FilteredRewards era
-&gt; Map
     (Credential 'Staking (EraCrypto era))
     (Set (Reward (EraCrypto era)))
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#frRegistered"><span class="hs-identifier hs-var hs-var">frRegistered</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520470"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Reward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520470"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>  </span><span class="hs-comment">-- ^ These are registered, in the current Unified map of the CertState</span><span>
</span><span id="line-315"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="frShelleyIgnored"><span class="annot"><span class="annottext">forall era.
FilteredRewards era
-&gt; Map
     (Credential 'Staking (EraCrypto era))
     (Set (Reward (EraCrypto era)))
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#frShelleyIgnored"><span class="hs-identifier hs-var hs-var">frShelleyIgnored</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520470"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Reward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520470"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>  </span><span class="hs-comment">-- ^ These are registered, but ignored in the ShelleyEra because of backward</span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-comment">--   compatibility in non-Shelley Eras, this field will be Map.empty</span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="frUnregistered"><span class="annot"><span class="annottext">forall era.
FilteredRewards era -&gt; Set (Credential 'Staking (EraCrypto era))
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#frUnregistered"><span class="hs-identifier hs-var hs-var">frUnregistered</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520470"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-comment">-- ^ These are NOT registered in the current Unified map of the CertState</span><span>
</span><span id="line-320"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="frTotalUnregistered"><span class="annot"><span class="annottext">forall era. FilteredRewards era -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#frTotalUnregistered"><span class="hs-identifier hs-var hs-var">frTotalUnregistered</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Coin</span></a></span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-comment">-- ^ Total Coin of the unregistered rewards. These will end up in the Treasury or Reserves.</span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679520455"><span class="annot"><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/deepseq-1.4.6.1/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#FilteredRewards"><span class="hs-identifier hs-type">FilteredRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520455"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-325"></span><span>  </span><span id="local-6989586621679520176"><span class="annot"><span class="annottext">rnf :: FilteredRewards era -&gt; ()
</span><a href="#local-6989586621679520176"><span class="hs-identifier hs-var hs-var hs-var hs-var">rnf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#FilteredRewards"><span class="hs-identifier hs-type">FilteredRewards</span></a></span><span> </span><span id="local-6989586621679520175"><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520175"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679520174"><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520174"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679520173"><span class="annot"><span class="annottext">Set (Credential 'Staking (EraCrypto era))
</span><a href="#local-6989586621679520173"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679520172"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520172"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520175"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. NFData a =&gt; a -&gt; b -&gt; b
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/deepseq-1.4.6.1/src"><span class="hs-operator hs-var">`deepseq`</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520174"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. NFData a =&gt; a -&gt; b -&gt; b
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/deepseq-1.4.6.1/src"><span class="hs-operator hs-var">`deepseq`</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Credential 'Staking (EraCrypto era))
</span><a href="#local-6989586621679520173"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. NFData a =&gt; a -&gt; b -&gt; b
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/deepseq-1.4.6.1/src"><span class="hs-operator hs-var">`deepseq`</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. NFData a =&gt; a -&gt; ()
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/deepseq-1.4.6.1/src"><span class="hs-identifier hs-var">rnf</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520172"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span class="hs-comment">-- | Return aggregated information from a reward mapping from the previous Epoch.</span><span>
</span><span id="line-328"></span><span class="hs-comment">--   Breaks the mapping into several parts captured by the 'Filtered' data type.</span><span>
</span><span id="line-329"></span><span class="hs-comment">--   Note that the 'registered' field of the returned (FilteredRewards) is a Map</span><span>
</span><span id="line-330"></span><span class="hs-comment">--   whose domain is always a subset of the Rewards View of the Unified Map in the DState of the EpochState.</span><span>
</span><span id="line-331"></span><span class="hs-comment">--   'prevPParams' is the ProtocolParams of the previous Epoch</span><span>
</span><span id="line-332"></span><span class="hs-comment">--   'rs' is the rewards mapping of the RewardUpdate from that previous Epoch</span><span>
</span><span id="line-333"></span><span id="local-6989586621679520469"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#filterAllRewards%27"><span class="hs-identifier hs-type">filterAllRewards'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-334"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520469"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Reward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520469"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-335"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">ProtVer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-336"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520469"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-337"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#FilteredRewards"><span class="hs-identifier hs-type">FilteredRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520469"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-338"></span><span id="filterAllRewards%27"><span class="annot"><span class="annottext">filterAllRewards' :: forall era.
Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
-&gt; ProtVer -&gt; DState era -&gt; FilteredRewards era
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#filterAllRewards%27"><span class="hs-identifier hs-var hs-var">filterAllRewards'</span></a></span></span><span> </span><span id="local-6989586621679520167"><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520167"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span id="local-6989586621679520166"><span class="annot"><span class="annottext">ProtVer
</span><a href="#local-6989586621679520166"><span class="hs-identifier hs-var">protVer</span></a></span></span><span> </span><span id="local-6989586621679520165"><span class="annot"><span class="annottext">DState era
</span><a href="#local-6989586621679520165"><span class="hs-identifier hs-var">dState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-339"></span><span>  </span><span class="annot"><span class="annottext">forall era.
Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
-&gt; Map
     (Credential 'Staking (EraCrypto era))
     (Set (Reward (EraCrypto era)))
-&gt; Set (Credential 'Staking (EraCrypto era))
-&gt; Coin
-&gt; FilteredRewards era
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#FilteredRewards"><span class="hs-identifier hs-var">FilteredRewards</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520164"><span class="hs-identifier hs-var">registered</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520163"><span class="hs-identifier hs-var">shelleyIgnored</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Credential 'Staking (EraCrypto era))
</span><a href="#local-6989586621679520162"><span class="hs-identifier hs-var">unregistered</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679520161"><span class="hs-identifier hs-var">totalUnregistered</span></a></span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-341"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679520160"><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520160"><span class="hs-identifier hs-var">regRU</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679520159"><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520159"><span class="hs-identifier hs-var">unregRU</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; (Map k a, Map k a)
</span><span class="hs-identifier hs-var">Map.partitionWithKey</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679520157"><span class="annot"><span class="annottext">Credential 'Staking (EraCrypto era)
</span><a href="#local-6989586621679520157"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">Set (Reward (EraCrypto era))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall k c v. k -&gt; View c k v -&gt; Bool
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">member</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking (EraCrypto era)
</span><a href="#local-6989586621679520157"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall era.
DState era
-&gt; View
     (EraCrypto era) (Credential 'Staking (EraCrypto era)) RDPair
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">rewards</span></a></span><span> </span><span class="annot"><span class="annottext">DState era
</span><a href="#local-6989586621679520165"><span class="hs-identifier hs-var">dState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520167"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-comment">-- Partition on memebership in the rewards view of the unified map of DState</span><span>
</span><span id="line-343"></span><span>    </span><span class="hs-comment">-- Note that only registered rewards appear in 'regRU' because of this 'member' check.</span><span>
</span><span id="line-344"></span><span>    </span><span id="local-6989586621679520161"><span class="annot"><span class="annottext">totalUnregistered :: Coin
</span><a href="#local-6989586621679520161"><span class="hs-identifier hs-var hs-var">totalUnregistered</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fold</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall c.
ProtVer
-&gt; Map (Credential 'Staking c) (Set (Reward c))
-&gt; Map (Credential 'Staking c) Coin
</span><a href="Cardano.Ledger.Shelley.Rewards.html#aggregateRewards"><span class="hs-identifier hs-var">aggregateRewards</span></a></span><span> </span><span class="annot"><span class="annottext">ProtVer
</span><a href="#local-6989586621679520166"><span class="hs-identifier hs-var">protVer</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520159"><span class="hs-identifier hs-var">unregRU</span></a></span><span>
</span><span id="line-345"></span><span>    </span><span id="local-6989586621679520162"><span class="annot"><span class="annottext">unregistered :: Set (Credential 'Staking (EraCrypto era))
</span><a href="#local-6989586621679520162"><span class="hs-identifier hs-var hs-var">unregistered</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; Set k
</span><span class="hs-identifier hs-var">Map.keysSet</span></span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520159"><span class="hs-identifier hs-var">unregRU</span></a></span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679520164"><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520164"><span class="hs-identifier hs-var">registered</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679520163"><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520163"><span class="hs-identifier hs-var">shelleyIgnored</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall c.
ProtVer
-&gt; Map (Credential 'Staking c) (Set (Reward c))
-&gt; (Map (Credential 'Staking c) (Set (Reward c)),
    Map (Credential 'Staking c) (Set (Reward c)))
</span><a href="Cardano.Ledger.Shelley.Rewards.html#filterRewards"><span class="hs-identifier hs-var">filterRewards</span></a></span><span> </span><span class="annot"><span class="annottext">ProtVer
</span><a href="#local-6989586621679520166"><span class="hs-identifier hs-var">protVer</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520160"><span class="hs-identifier hs-var">regRU</span></a></span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span id="local-6989586621679520433"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#filterAllRewards"><span class="hs-identifier hs-type">filterAllRewards</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-349"></span><span>  </span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraPParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520433"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-350"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520433"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">Reward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-type">EraCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520433"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-351"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520433"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-352"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#FilteredRewards"><span class="hs-identifier hs-type">FilteredRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520433"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-353"></span><span id="filterAllRewards"><span class="annot"><span class="annottext">filterAllRewards :: forall era.
EraPParams era =&gt;
Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
-&gt; EpochState era -&gt; FilteredRewards era
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#filterAllRewards"><span class="hs-identifier hs-var hs-var">filterAllRewards</span></a></span></span><span> </span><span id="local-6989586621679520152"><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520152"><span class="hs-identifier hs-var">mp</span></a></span></span><span> </span><span id="local-6989586621679520151"><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679520151"><span class="hs-identifier hs-var">epochstate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era.
Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
-&gt; ProtVer -&gt; DState era -&gt; FilteredRewards era
</span><a href="Cardano.Ledger.Shelley.LedgerState.IncrementalStake.html#filterAllRewards%27"><span class="hs-identifier hs-var">filterAllRewards'</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking (EraCrypto era))
  (Set (Reward (EraCrypto era)))
</span><a href="#local-6989586621679520152"><span class="hs-identifier hs-var">mp</span></a></span><span> </span><span class="annot"><span class="annottext">ProtVer
</span><a href="#local-6989586621679520150"><span class="hs-identifier hs-var">prevPP</span></a></span><span> </span><span class="annot"><span class="annottext">DState era
</span><a href="#local-6989586621679520149"><span class="hs-identifier hs-var">dState</span></a></span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-355"></span><span>    </span><span id="local-6989586621679520150"><span class="annot"><span class="annottext">prevPP :: ProtVer
</span><a href="#local-6989586621679520150"><span class="hs-identifier hs-var hs-var">prevPP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall era. EpochState era -&gt; PParams era
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#esPrevPp"><span class="hs-identifier hs-var">esPrevPp</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679520151"><span class="hs-identifier hs-var">epochstate</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">forall era. EraPParams era =&gt; Lens' (PParams era) ProtVer
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">ppProtocolVersionL</span></a></span><span>
</span><span id="line-356"></span><span>    </span><span id="local-6989586621679520149"><span class="annot"><span class="annottext">dState :: DState era
</span><a href="#local-6989586621679520149"><span class="hs-identifier hs-var hs-var">dState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall era. CertState era -&gt; DState era
</span><a href="../file:///home/runner/work/cardano-ledger/cardano-ledger/dist-newstyle/build/x86_64-linux/ghc-9.2.7/cardano-ledger-core-1.2.0.0/doc/html/cardano-ledger-core/src"><span class="hs-identifier hs-var">certDState</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall era. LedgerState era -&gt; CertState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#lsCertState"><span class="hs-identifier hs-var">lsCertState</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/7wd7lm23cjb3mrp5rh6ag573znf82xlz-ghc-9.2.7-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall era. EpochState era -&gt; LedgerState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.Types.html#esLState"><span class="hs-identifier hs-var">esLState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679520151"><span class="hs-identifier hs-var">epochstate</span></a></span><span>
</span><span id="line-357"></span></pre></body></html>